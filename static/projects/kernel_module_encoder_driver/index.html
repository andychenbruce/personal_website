<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Linux Device Driver for a Motor Encoder</title>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/default.min.css">
    <link rel="stylesheet" href="/style.css" />  
    <script src="/andy_replace.js" type="module"></script>
    <script src="/andy_include_code.js" type="module"></script>
  </head>
  <body>
    <div class="wrapperDiv">
      <div class="andy_replace" src="/includes/navbar.html"></div>
      <div class="headerDiv">
	<h1>Linux Device Driver for a Motor Encoder</h1>
      </div>
      <div class="contentDiv">

	<div class="imageContainer" class="floatLeft">
	  <img src="i05-Uxcell-Motor.jpg" width="465" height="349" /><div class="imageCaption" style="width:465 px;">Uxcell gear motor with encoder
	</div></div>


	<p>A <a href="https://en.wikipedia.org/wiki/Rotary_encoder">rotary encoder</a> is an electro-mechanical device that senses rotation of a motor shaft and converts it into a digital signal that can be processed by a computer.
	</p>

	<div class="imageContainer" class="floatLeft">
	  <img src="i05-Encoder-Wires.jpg" width="423" height="362" /><div class="imageCaption" style="width:423 px;">Encoder on the end of the motor shaft
	</div></div>

	<p>
	  For my robot project, I used two Uxcell gear motors with
	  <a href="https://en.wikipedia.org/wiki/Hall_effect_sensor">Hall effect encoders</a>.
	  I bought the
	  <a href="https://www.amazon.com/gp/product/B0792RX5X1/">motors from Amazon</a>.
	  The encoders have 16 magnets and two hall effect sensors.  The magnets produce a rising
	  and falling signal as they pass each sensor.  So there are 64 encoder interrupts per
	  revolution of the motor.  The motors have a 30:1 gear ratio, so there are
	  64*30 = 1920 pulses for each revolution of the gearbox shaft.
	  That is plenty of resolution to navigate the robot.
	</p>

	<hr class="clearLeft" />
	
	<div class="imageContainer" class="floatLeft">
	  <img src="i05-Incremental_directional_encoder.gif" width="258" height="150" /><div class="imageCaption" style="width:258 px;">Incremental directional encoder
	</div></div>

	<div class="imageContainer" class="floatLeft">
	  <img src="i05-EncoderSignals.png" width="300" height="249" /><div class="imageCaption" style="width:300 px;">Encoder signals
	</div></div>

	<div class="imageContainer" class="floatLeft">
	  <img src="i05-EncoderFwdBwd.jpg" width="255" height="250" /><div class="imageCaption" style="width:255 px;">Forward and backwards rotations
	</div></div>

	<p>The sequence of interrupts tells us both the speed of the motor and the direction it is turning.
	  The rotary position (Position), the rate it is changing (Derivative), and the accumulated error (Integral) can be used in a Position-Derivative-Integral <a href="https://en.wikipedia.org/wiki/PID_controller">PID feedback control loop</a>.  The feedback is used to control the PWM signal to the motors.</p>
	
	<hr class="clearLeft" />
	<p>
	  Reading the encoder interrupts is done in the Linux kernel on the
	  Raspberry Pi. The device driver receives an interrupt for each
	  encoder tick and increments or decrements the count in a data
	  structure. The data is mapped to the address of an application
	  using mmap().</p>
	<p>The source code for the device driver is listed below.</p>
	<pre><code class="codeClass andy_include_code language-c" src="encoderDriver.c"></code></pre>
	<hr class="clearLeft" />
	<p>This is the user program for reading the encoder counts.</p>
	<pre><code class="codeClass andy_include_code language-c" src="encoderDriver.c"></code></pre>
	<hr class="clearLeft" />
	<p>This is the Makefile for compiling the source code listed above.</p>
	<pre><code class="codeClass andy_include_code language-makefile" src="encoder.makefile"></code></pre>
	<hr class="clearLeft" />
	<p>This is a Python script for the GUI to display the encoder counts in the video.</p>
	<pre><code class="codeClass andy_include_code language-python" src="gui.py">
	    	</code></pre>
	<hr class="clearLeft" />
	
	<div class="imageContainer" class="floatLeft">
	  <video class=floatLeft width="640" controls><source src="Encoder-480.mp4" type="video/mp4" />Your browser does not support the video tab.
	  </video>
	  <div class="imageCaption" style="width:640px;">Testing the encoder driver.
	</div></div>
	
	<hr class="clearLeft" />
	
	<hr class="clearLeft" />
      </div>
    </div>
  </body>
</html>
